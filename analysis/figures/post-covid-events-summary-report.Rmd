---
title: "Post-Covid-Events Results Summary Report"
output:
  html_document:
    df_print: paged
    toc: true
    theme: united
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(magrittr)
library(dplyr)
library(stringr)
library(cowplot)
library(magick)

results_dir <- "/Users/kt17109/OneDrive - University of Bristol/Documents - grp-EHR/Projects/post-covid-diabetes/OS-outputs/OS-output-9june2022/"
output_dir <- "/Users/kt17109/OneDrive - University of Bristol/Documents - grp-EHR/Projects/post-covid-diabetes/OS-outputs/OS-output-9june2022/figures/"

# this should be changed to the outcome group (e.g. diabetes, diabetes_gestational, mental_health)
outcome <- "diabetes"
# add here all of the outcomes that you have venn diagrams for
venn_prefixs <- c("t2dm", "t1dm")
```


# Summary

This is a brief report generated using markdown to provide a summary of results from post-covid-events analyses performed in OpenSAFELY. 

\newpage
\blandscape

# Table 1

## Number of patients analysed in OpenSAFELY, and the numbers of people who were exposed to COVID-19 and those who were and were not hospitalised within 28 days of diagnosis of COVID-19.

```{r T1, out.width="100%"}
table1 <- read.csv(paste0(results_dir,"Table1_",outcome,".csv"))

# CLEAN TABLE 1

table1 <- table1 %>% 
  
  mutate(COVID_exposed_perc = (COVID_exposed/Whole_population)*100,
         COVID_hospitalised_perc = (COVID_hospitalised/COVID_exposed)*100,
         COVID_non_hospitalised_perc = (COVID_non_hospitalised/COVID_exposed)*100) %>%
  mutate_if(is.numeric, round, 1) %>%
  
  mutate(Whole_population = formatC(round(Whole_population), format = "f", big.mark = ",", drop0trailing = TRUE),
         COVID_exposed = formatC(round(COVID_exposed), format = "f", big.mark = ",", drop0trailing = TRUE),
         COVID_hospitalised = formatC(round(COVID_hospitalised), format = "f", big.mark = ",", drop0trailing = TRUE),
         COVID_non_hospitalised = formatC(round(COVID_non_hospitalised), format = "f", big.mark = ",", drop0trailing = TRUE),) %>%
  
  mutate("COVID exposed (%)" = paste0(COVID_exposed, " (", COVID_exposed_perc, ")"),
         "COVID hospitalised (% of exposed)" = paste0(COVID_hospitalised, " (", COVID_hospitalised_perc, ")"),
         "COVID non-hospitalised (% of exposed)" = paste0(COVID_non_hospitalised, " (", COVID_non_hospitalised_perc, ")"),
         "Covariate Level" = Covariate_level) %>%
  
  dplyr::select("Covariate", "Covariate Level", "Whole_population", "COVID exposed (%)", "COVID hospitalised (% of exposed)", "COVID non-hospitalised (% of exposed)")

pander::pander(table1, split.cell = 10, split.table = Inf)
```

\newpage

# Table 2

## Numbers of events in OpenSAFELY before and after diagnosis of COVID-19.

```{r T2, out.width="100%"}
table2 <- read.csv(paste0(results_dir,"table2_",outcome,".csv"))
table2 <- table2 %>% dplyr::select(-subgroup, -stratify_by_subgroup)
# remove "_" to tidy up a little
table2 <- data.frame(lapply(table2, function(x) {
          gsub("_", " ", x)
              }))
colnames(table2) = gsub("_", " ", colnames(table2))

pander::pander(table2, split.cells = 8)
```

\newpage

# Venn Diagrams

```{r figSvg,eval=TRUE,echo=FALSE,message=FALSE, error=FALSE, warning=FALSE, fig.height=4}
for(i in venn_prefixs){
fig_svg <- cowplot::ggdraw()+cowplot::draw_image(paste0(results_dir,"venn_diagram_",outcome,"_",i,".svg"))
plot(fig_svg)
}
```

\elandscape

\newpage

# Figure 1

## Age/sex/region adjusted and maximally adjusted hazard ratios (log scale) for different events by time since diagnosis of COVID-19.

```{r echo=FALSE, results = 'asis', out.width="80%"}
knitr::include_graphics(paste0(results_dir,"Figure1_unvaccinated_",outcome,".png"))
```

\newpage

# Figure 2

## Hazard ratios (log scale) for event after COVID-19 stratified by subgroups (N.B. subgroups included will depend on outcome and number of events).

```{r echo=FALSE, results = 'asis', out.width="80%"}
knitr::include_graphics(paste0(results_dir,"figure2_COVID_phenotype_unvaccinated_",outcome,".png"))
```

\newpage
\blandscape

# Diabetes flow chart

## Flow chart showing the assignment of diabetes cases using the diabetes algorithm. 

```{r echo=FALSE}
show_flow <- ifelse(outcome=="diabetes", TRUE, FALSE)
```

```{r conditional_block, eval=show_flow, out.width="75%"}
knitr::include_graphics(paste0(results_dir,"diabetes_flow_",outcome,".png"))
```

\elandscape